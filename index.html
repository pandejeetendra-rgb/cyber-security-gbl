<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Net Path Adventure</title>

  <style>
    :root{
      --bg1:#f7f9ff;
      --bg2:#eef3ff;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#546074;
      --border:rgba(15,23,42,.10);
      --primary:#2563eb;
      --primary2:#4f46e5;
      --success:#16a34a;
      --danger:#dc2626;
      --shadow: 0 16px 40px rgba(15,23,42,0.12);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      min-height:100vh;
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(79,70,229,.14), transparent 60%),
        radial-gradient(850px 520px at 80% 10%, rgba(37,99,235,.14), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }
    .container{ max-width: 980px; margin: 0 auto; padding: 16px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin: 4px 0 14px;
      flex-wrap:wrap;
    }
    .brand{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 12px 26px rgba(37,99,235,.25);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-weight:900; letter-spacing:.5px;
      user-select:none;
      flex: 0 0 auto;
    }
    .brand h1{ margin:0; font-size:18px; line-height:1.1; }
    .brand small{ display:block; color: var(--muted); margin-top: 3px; }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.72);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 13px;
      color: var(--muted);
      backdrop-filter: blur(8px);
    }
    .chip b{ color: var(--text); }
    .chip button{
      border:none; background:transparent; padding:0; cursor:pointer;
      color: var(--primary); font-weight:900;
    }

    .card{
      background: rgba(255,255,255,.90);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    .pad{ padding: 16px; }

    .grid{ display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 900px){
      .grid.two{ grid-template-columns: 1.2fr .8fr; }
    }

    .btn-row{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 12px; }
    button{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.95);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor: pointer;
      font-weight: 900;
    }
    button.primary{
      border: none;
      color:#fff;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      box-shadow: 0 14px 28px rgba(37,99,235,.25);
    }
    button.ghost{ background: transparent; }
    button:disabled{ opacity:.55; cursor:not-allowed; }

    a.link{
      color: var(--primary);
      font-weight: 900;
      text-decoration: none;
    }

    .muted{ color: var(--muted); font-size: 13px; line-height:1.45; }

    .level-list{ display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }
    @media (min-width: 700px){ .level-list{ grid-template-columns: 1fr 1fr; } }

    .level-card{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.92);
      border-radius: 18px;
      padding: 14px;
      cursor:pointer;
      display:flex;
      gap: 12px;
      align-items: flex-start;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .level-card:hover{ transform: translateY(-2px); box-shadow: 0 18px 44px rgba(15,23,42,0.14); }
    .level-card.locked{ opacity:.58; cursor:not-allowed; }
    .badge{
      width:42px; height:42px; border-radius: 14px;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(37,99,235,.10), rgba(37,99,235,.03));
      display:flex; align-items:center; justify-content:center;
      font-weight: 900; color: var(--primary);
      flex: 0 0 auto;
    }
    .level-card h3{ margin:0; font-size: 15px; }
    .meta{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 6px; }
    .pill{
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 5px 8px;
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,.72);
    }
    .tags{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }
    .tag{
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 5px 8px;
      font-size: 12px;
      color: var(--muted);
      background: rgba(255,255,255,.70);
    }

    .play-header{
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
      margin-bottom: 10px;
      flex-wrap:wrap;
    }
    .play-title{ font-weight: 900; }
    .progress-wrap{ display:flex; flex-direction:column; gap:6px; min-width: 240px; flex:1; }
    .progress{
      width: 100%;
      height: 10px;
      background: rgba(37,99,235,.10);
      border: 1px solid var(--border);
      border-radius: 999px;
      overflow:hidden;
    }
    .progress > div{
      height:100%;
      background: linear-gradient(135deg, var(--primary), var(--primary2));
      width:0%;
    }

    /* Scene */
    .scene{
      position: relative;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid var(--border);
      min-height: 320px;
      background:
        radial-gradient(900px 400px at 20% 10%, rgba(37,99,235,.13), transparent 60%),
        radial-gradient(900px 400px at 80% 0%, rgba(79,70,229,.12), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.2));
    }
    .scene .bgimg{
      position:absolute; inset:0;
      background-position:center;
      background-size: cover;
      opacity: 0;
      transform: scale(1.02);
      transition: opacity .25s ease;
      z-index: 0;
    }
    .scene.gbl .bgimg{ opacity: .96; }
    .scene.gbl .bgimg.animate{
      animation: bgpan 10s ease-in-out infinite alternate;
    }
    @keyframes bgpan{
      from{ transform: scale(1.02) translateX(0px); }
      to{ transform: scale(1.06) translateX(-12px); }
    }
    .scene .mode-label{
      position:absolute; top: 12px; left: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.80);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      backdrop-filter: blur(8px);
      z-index: 4;
    }
    .scene .hint-strip{
      position:absolute; bottom: 12px; left: 12px; right: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.82);
      padding: 10px 12px;
      border-radius: 14px;
      font-size: 13px;
      color: var(--muted);
      backdrop-filter: blur(8px);
      z-index: 4;
    }
    .scene svg{
      position:absolute; inset:0;
      width:100%; height:100%;
      z-index: 2;
      pointer-events:none;
    }

    .dialogue{ display:flex; gap: 12px; align-items:flex-start; }
    .avatar{
      width:44px; height:44px; border-radius: 16px;
      background: linear-gradient(135deg, rgba(37,99,235,.18), rgba(79,70,229,.14));
      border: 1px solid var(--border);
      display:flex; align-items:center; justify-content:center;
      font-weight: 900; color: var(--primary);
      user-select:none;
      flex: 0 0 auto;
    }
    .bubble{
      flex:1;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.92);
      border-radius: 18px;
      padding: 12px 12px;
      position: relative;
    }
    .bubble:before{
      content:"";
      position:absolute;
      left:-7px;
      top: 14px;
      width: 14px;
      height: 14px;
      background: rgba(255,255,255,.92);
      border-left: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      transform: rotate(45deg);
    }
    .speaker{ font-weight: 900; margin-bottom: 6px; }
    .text{ line-height: 1.45; color: var(--text); }

    /* Modal */
    .modal-backdrop{
      position: fixed; inset:0;
      background: rgba(15,23,42,.48);
      display:flex; align-items:center; justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .modal{
      width: 100%;
      max-width: 760px;
      background: rgba(255,255,255,.95);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(8px);
    }
    .modal header{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .modal header h3{ margin:0; font-size: 16px; }
    .modal .body{ padding: 14px 16px; }
    .qtitle{ font-weight: 900; margin-bottom: 10px; }
    .option{
      width:100%;
      text-align:left;
      margin: 8px 0;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.96);
      font-weight: 900;
      transition: transform .08s ease, box-shadow .08s ease, border-color .08s ease;
    }
    .option:hover{ transform: translateY(-1px); }
    .option.selected{
      border-color: rgba(37,99,235,.65);
      box-shadow: 0 0 0 4px rgba(37,99,235,.14);
    }
    .feedback{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,.03);
      color: var(--muted);
    }
    .feedback.good{ border-color: rgba(22,163,74,.30); color: #14532d; background: rgba(22,163,74,.08); }
    .feedback.bad{ border-color: rgba(220,38,38,.30); color: #7f1d1d; background: rgba(220,38,38,.08); }
    .modal footer{
      padding: 14px 16px;
      border-top: 1px solid var(--border);
      display:flex; flex-wrap:wrap; gap:10px; justify-content:flex-end;
    }

    /* Toast */
    .toast{
      position: fixed; left: 50%; bottom: 22px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.92);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      z-index: 60;
      display:none;
      backdrop-filter: blur(8px);
    }
    .toast.show{ display:block; }

    /* Error banner */
    .err{
      position: fixed;
      left: 12px; right: 12px; bottom: 12px;
      z-index: 999;
      display:none;
    }
    .err .box{
      max-width: 980px; margin: 0 auto;
      background: rgba(255,255,255,.96);
      border: 1px solid rgba(220,38,38,.30);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 12px 14px;
      color: #7f1d1d;
      font-weight: 900;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
    }
    .err .box small{
      display:block;
      margin-top: 4px;
      font-weight: 700;
      color: rgba(127,29,29,.85);
    }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  </style>
</head>

<body>
  <div id="app"></div>
  <div id="modal-root"></div>
  <div id="toast" class="toast">Done ✔</div>

  <div id="err" class="err">
    <div class="box">
      <div>
        Something failed in JavaScript.
        <small id="errText"></small>
      </div>
      <button id="errClose" class="ghost" style="border-color:rgba(220,38,38,.25);">Close</button>
    </div>
  </div>

  <script>
    // ---------------------------
    // Mode
    // ---------------------------
    const qs = new URLSearchParams(location.search);
    const MODE = (qs.get("mode") || "gbl").toLowerCase(); // gbl | control

    // ---------------------------
    // Keys
    // ---------------------------
    const STORAGE_KEY = "net_path_progress_v4";
    const LOG_KEY = "net_path_research_log_v2";
    const SESSION_KEY = "net_path_session_id_v2";

    const APP = document.getElementById("app");
    const MODAL = document.getElementById("modal-root");
    const TOAST = document.getElementById("toast");

    // ---------------------------
    // Error visibility
    // ---------------------------
    const ERR = document.getElementById("err");
    const ERR_TEXT = document.getElementById("errText");
    document.getElementById("errClose").onclick = () => { ERR.style.display="none"; };

    function showError(msg){
      ERR_TEXT.textContent = String(msg || "Unknown error");
      ERR.style.display = "block";
    }
    window.addEventListener("error", (e) => {
      const m = (e && e.message) ? e.message : "Unknown error";
      const ln = (e && e.lineno) ? ("Line " + e.lineno) : "";
      showError(m + (ln ? (" • " + ln) : ""));
    });
    window.addEventListener("unhandledrejection", (e) => {
      const r = e && e.reason ? (e.reason.message || String(e.reason)) : "Unknown promise rejection";
      showError(r);
    });

    // ---------------------------
    // Session id (pseudonymous)
    // ---------------------------
    function makeId(prefix){
      return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }
    function getSessionId(){
      let sid = localStorage.getItem(SESSION_KEY);
      if(!sid){
        sid = makeId("S");
        localStorage.setItem(SESSION_KEY, sid);
      }
      return sid;
    }
    const SESSION_ID = getSessionId();

    // ---------------------------
    // Research logging (rich)
    // ---------------------------
    const Research = {
      read(){ try{ return JSON.parse(localStorage.getItem(LOG_KEY) || "[]"); }catch{ return []; } },
      write(rows){ localStorage.setItem(LOG_KEY, JSON.stringify(rows || [])); },
      log(evt){
        const rows = Research.read();
        rows.push({ ts_iso: new Date().toISOString(), session_id: SESSION_ID, mode: MODE, ...evt });
        Research.write(rows);
      },
      clear(){
        Research.write([]);
        Research.log({ event:"log_cleared" });
      },
      toCSV(){
        const rows = Research.read();
        const cols = rows.length ? Array.from(new Set(rows.flatMap(r => Object.keys(r)))) : ["ts_iso","session_id","mode","event"];
        const esc = (v) => {
          const s = (v === null || v === undefined) ? "" : String(v);
          const needs = /[",\n]/.test(s);
          const out = s.replaceAll('"','""');
          return needs ? `"${out}"` : out;
        };
        const lines = [];
        lines.push(cols.map(esc).join(","));
        for(const r of rows) lines.push(cols.map(c => esc(r[c])).join(","));
        return lines.join("\n");
      },
      downloadCSV(name){
        Research.log({ event:"export_csv_clicked", rows_exported: Research.read().length });
        const csv = Research.toCSV();
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = name || `net_path_log_${SESSION_ID}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 500);
      }
    };

    Research.log({ event:"session_start", page: location.pathname + location.search });

    function logNav(eventName, extra = {}){
      Research.log({ event: eventName, ...extra });
    }

    // ---------------------------
    // UI config
    // ---------------------------
    const UI = {
      deterministic_shuffle: true,
      mcq_shuffle_options: true,
      hint_tokens_enabled: true,
      max_hints_per_level: 3,
      lock_until_correct: true
    };

    // ---------------------------
    // Background assets (per level)
    // ---------------------------
    const ASSETS = {
      L1: "assets/l1.png",
      L2: "assets/l2.png",
      L3: "assets/l3.png",
      L4: "assets/l4.png",
      L5: "assets/l5.png"
    };

    // ---------------------------
    // CONTENT (you can replace MCQs later)
    // ---------------------------
    const CONTENT = {
      levels: [
        { level_id:"L1", level_title:"From ISP to Your Home", learning_focus:["ISP","Last-mile","ONT/Modem","Router","Wi-Fi"], steps:[
          { step_id:"L1_S1", scene_id:"SC_CITY_TO_HOME",
            dialogue:{speaker:"Guide Bot",text:"Your Internet starts at the ISP. The ISP sends service to your area using high-speed links."},
            mcq:{question_id:"L1Q1",question_text:"Where does your Internet service start (as per dialogue)?",
              choices:["At the ISP","Inside the laptop","At the Wi-Fi password","In the browser"], correct_answer:"At the ISP",
              feedback:{correct:"Correct.",wrong:"Try again. The first sentence answers it."}}
          },
          { step_id:"L1_S2", scene_id:"SC_HOME_FRONT",
            dialogue:{speaker:"Guide Bot",text:"When the line reaches your home, it connects to ONT/modem which converts the signal for home use."},
            mcq:{question_id:"L1Q2",question_text:"Which device converts the incoming line signal?",
              choices:["ONT/Modem","Keyboard","Printer","USB drive"], correct_answer:"ONT/Modem",
              feedback:{correct:"Correct.",wrong:"Try again. The dialogue names it."}}
          },
          { step_id:"L1_S3", scene_id:"SC_LIVING_ROOM",
            dialogue:{speaker:"Guide Bot",text:"The ONT/modem connects to a router. The router shares the Internet connection with multiple devices."},
            mcq:{question_id:"L1Q3",question_text:"What is the router’s role (as per dialogue)?",
              choices:["Share Internet with multiple devices","Increase brightness","Charge phones","Store movies"], correct_answer:"Share Internet with multiple devices",
              feedback:{correct:"Correct.",wrong:"Try again. The dialogue states it."}}
          },
          { step_id:"L1_S4", scene_id:"SC_LIVING_ROOM",
            dialogue:{speaker:"Guide Bot",text:"Wi-Fi is the wireless connection provided by the router. A password prevents unauthorized access."},
            mcq:{question_id:"L1Q4",question_text:"What prevents unauthorized Wi-Fi access?",
              choices:["A password","A mouse pad","A bigger monitor","A screenshot"], correct_answer:"A password",
              feedback:{correct:"Correct.",wrong:"Try again. Check the last sentence."}}
          },
          { step_id:"L1_S5", scene_id:"SC_HOME_NETWORK_OVERVIEW",
            dialogue:{speaker:"Guide Bot",text:"The basic path is: ISP → ONT/Modem → Router → Your devices."},
            mcq:{question_id:"L1Q5",question_text
              :"Which sequence matches the dialogue?",
              choices:["ISP → ONT/Modem → Router → Devices","Devices → Router → ISP → Modem","Router → ISP → Devices → Modem","Modem → Devices → ISP → Router"],
              correct_answer:"ISP → ONT/Modem → Router → Devices",
              feedback:{correct:"Correct.",wrong:"Try again. It is written in the dialogue."}}
          },
        ]},
        { level_id:"L2", level_title:"Inside the Home Network", learning_focus:["Addresses","Auto assignment","Wired/Wi-Fi","Switch","Shared bandwidth"], steps:[
          { step_id:"L2_S1", scene_id:"SC_HOME_BLUEPRINT",
            dialogue:{speaker:"Guide Bot",text:"Inside your home, each device needs an address so data reaches the correct device."},
            mcq:{question_id:"L2Q1",question_text:"Why does each device need an address?",
              choices:["So data reaches the correct device","To increase battery","To download games automatically","To change resolution"],
              correct_answer:"So data reaches the correct device",
              feedback:{correct:"Correct.",wrong:"Try again. The last phrase answers it."}}
          },
          { step_id:"L2_S2", scene_id:"SC_ROUTER_SETTINGS",
            dialogue:{speaker:"Guide Bot",text:"Routers often assign addresses automatically to save time for new devices."},
            mcq:{question_id:"L2Q2",question_text:"What is the benefit of automatic address assignment?",
              choices:["No manual setup for each new device","It makes monitor brighter","It changes camera quality","It blocks all websites"],
              correct_answer:"No manual setup for each new device",
              feedback:{correct:"Correct.",wrong:"Try again. The dialogue explains the time saving."}}
          },
          { step_id:"L2_S3", scene_id:"SC_LIVING_ROOM",
            dialogue:{speaker:"Guide Bot",text:"Wired connections are stable; Wi-Fi is convenient for mobility."},
            mcq:{question_id:"L2Q3",question_text:"What is a key benefit of Wi-Fi (as per dialogue)?",
              choices:["Convenience for mobility","Always faster than wired","Works without router","No password needed"],
              correct_answer:"Convenience for mobility",
              feedback:{correct:"Correct.",wrong:"Try again. The dialogue compares wired vs Wi-Fi."}}
          },
          { step_id:"L2_S4", scene_id:"SC_HOME_OFFICE",
            dialogue:{speaker:"Guide Bot",text:"A switch provides extra ports so multiple wired devices can join the network."},
            mcq:{question_id:"L2Q4",question_text:"Why use a switch?",
              choices:["To connect multiple wired devices","To create Wi-Fi password","To replace ISP","To convert fiber signal"],
              correct_answer:"To connect multiple wired devices",
              feedback:{correct:"Correct.",wrong:"Try again. The dialogue defines switch purpose."}}
          },
          { step_id:"L2_S5", scene_id:"SC_HOME_BLUEPRINT",
            dialogue:{speaker:"Guide Bot",text:"All devices share the same Internet connection. Many simultaneous downloads can slow each device."},
            mcq:{question_id:"L2Q5",question_text:"Why may speed feel slower when many devices are active?",
              choices:["Devices share the same connection","Screen is small","Router forgets passwords","Cables become longer"],
              correct_answer:"Devices share the same connection",
              feedback:{correct:"Correct.",wrong:"Try again. The first sentence explains it."}}
          },
        ]},
        { level_id:"L3", level_title:"Wi-Fi Basics: Speed, Coverage, Security", learning_focus:["Internet vs Wi-Fi","Speed factors","Coverage","Encryption","Guest Wi-Fi"], steps:[
          { step_id:"L3_S1", scene_id:"SC_WIFI_OVERVIEW",
            dialogue:{speaker:"Guide Bot",text:"Internet comes from the ISP. Wi-Fi is your local wireless connection inside the home."},
            mcq:{question_id:"L3Q1",question_text:"According to dialogue, what is Wi-Fi?",
              choices:["Local wireless connection inside home","The ISP itself","A type of browser","A mobile app"],
              correct_answer:"Local wireless connection inside home",
              feedback:{correct:"Correct.",wrong:"Try again. The second sentence defines it."}}
          },
          { step_id:"L3_S2", scene_id:"SC_WIFI_SPEED",
            dialogue:{speaker:"Guide Bot",text:"Your experience depends on ISP speed and also your Wi-Fi quality. Either one can be a bottleneck."},
            mcq:{question_id:"L3Q2",question_text:"What can affect speed as per dialogue?",
              choices:["ISP speed and Wi-Fi quality","Only phone brand","Only laptop size","Only wall color"],
              correct_answer:"ISP speed and Wi-Fi quality",
              feedback:{correct:"Correct.",wrong:"Try again. The dialogue mentions two factors."}}
          },
          { step_id:"L3_S3", scene_id:"SC_WIFI_COVERAGE",
            dialogue:{speaker:"Guide Bot",text:"Distance and walls can weaken Wi-Fi signals in different rooms."},
            mcq:{question_id:"L3Q3",question_text:"What can weaken Wi-Fi signals (as per dialogue)?",
              choices:["Distance and walls","Keyboard type","Screen brightness","Battery percent"],
              correct_answer:"Distance and walls",
              feedback:{correct:"Correct.",wrong:"Try again. The sentence names the factors."}}
          },
          { step_id:"L3_S4", scene_id:"SC_WIFI_SECURITY",
            dialogue:{speaker:"Guide Bot",text:"Encryption helps protect data between your device and router, making it harder for outsiders to read."},
            mcq:{question_id:"L3Q4",question_text:"What is the effect of encryption (as per dialogue)?",
              choices:["Harder for outsiders to read data","Makes router bigger","Deletes phone photos","Stops all internet"],
              correct_answer:"Harder for outsiders to read data",
              feedback:{correct:"Correct.",wrong:"Try again. The dialogue states the effect."}}
          },
          { step_id:"L3_S5", scene_id:"SC_WIFI_GUEST",
            dialogue:{speaker:"Guide Bot",text:"Guest Wi-Fi lets visitors use internet without joining your main network, improving safety."},
            mcq:{question_id:"L3Q5",question_text:"Why is guest Wi-Fi helpful (as per dialogue)?",
              choices:["Separates visitors from main network","Removes need for router","Gives free ISP internet","Guarantees max speed"],
              correct_answer:"Separates visitors from main network",
              feedback:{correct:"Correct.",wrong:"Try again. The dialogue explains separation."}}
          },
        ]},
        { level_id:"L4", level_title:"ISP Access Technologies", learning_focus:["Cable modem","DSL modem","CMTS","DSLAM","Access overview"], steps:[
          { step_id:"L4_S1", scene_id:"SC_ISP_CABLE",
            dialogue:{speaker:"Guide Bot",text:"Cable Internet uses a cable modem at home and connects to a CMTS at the provider."},
            mcq:{question_id:"L4Q1",question_text:"Cable Internet connects cable modems to which provider device?",
              choices:["CMTS","DSLAM","Printer","Keyboard"], correct_answer:"CMTS",
              feedback:{correct:"Correct.",wrong:"Try again. CMTS is named in the dialogue."}}
          },
          { step_id:"L4_S2", scene_id:"SC_ISP_DSL",
            dialogue:{speaker:"Guide Bot",text:"DSL Internet uses a DSL modem and connects to a DSLAM at the provider side."},
            mcq:{question_id:"L4Q2",question_text:"DSL Internet connects DSL modems to which provider device?",
              choices:["DSLAM","CMTS","Mouse","Monitor"], correct_answer:"DSLAM",
              feedback:{correct:"Correct.",wrong:"Try again. DSLAM is named in the dialogue."}}
          },
          { step_id:"L4_S3", scene_id:"SC_CMTS",
            dialogue:{speaker:"Guide Bot",text:"CMTS aggregates traffic from many cable subscribers and forwards it to the ISP network."},
            mcq:{question_id:"L4Q3",question_text:"What is CMTS role (as per dialogue)?",
              choices:["Aggregates cable subscriber traffic","Creates Wi-Fi passwords","Stores videos","Improves screen resolution"],
              correct_answer:"Aggregates cable subscriber traffic",
              feedback:{correct:"Correct.",wrong:"Try again. The dialogue defines CMTS."}}
          },
          { step_id:"L4_S4", scene_id:"SC_DSLAM",
            dialogue:{speaker:"Guide Bot",text:"DSLAM terminates multiple DSL lines and connects them to the ISP network."},
            mcq:{question_id:"L4Q4",question_text:"What does DSLAM do (as per dialogue)?",
              choices:["Terminates DSL lines and connects to ISP","Replaces router","Acts as keyboard","Charges phone"],
              correct_answer:"Terminates DSL lines and connects to ISP",
              feedback:{correct:"Correct.",wrong:"Try again. The dialogue explains DSLAM."}}
          },
          { step_id:"L4_S5", scene_id:"SC_ISP_ACCESS_OVERVIEW",
            dialogue:{speaker:"Guide Bot",text:"Cable and DSL are different access methods, but both ultimately connect users to the ISP Internet."},
            mcq:{question_id:"L4Q5",question_text:"What is common in both Cable and DSL (as per dialogue)?",
              choices:["Both connect users to ISP Internet","Both remove need for modem","Both work without provider equipment","Both guarantee same speed"],
              correct_answer:"Both connect users to ISP Internet",
              feedback:{correct:"Correct.",wrong:"Try again. The last phrase states the common point."}}
          },
        ]},
        { level_id:"L5", level_title:"Advanced Network: Switches, APs, IoT", learning_focus:["Switch scaling","Multiple APs","Segmentation idea","IoT camera","Overview"], steps:[
          { step_id:"L5_S1", scene_id:"SC_ADVANCED_NETWORK",
            dialogue:{speaker:"Guide Bot",text:"As networks grow, switches help connect many wired devices while the router handles routing."},
            mcq:{question_id:"L5Q1",question_text:"What helps connect many wired devices (as per dialogue)?",
              choices:["Switch","Browser","Wallpaper","Screenshot"], correct_answer:"Switch",
              feedback:{correct:"Correct.",wrong:"Try again. Switch is named."}}
          },
          { step_id:"L5_S2", scene_id:"SC_MULTIPLE_APS",
            dialogue:{speaker:"Guide Bot",text:"Multiple access points improve coverage across rooms, connected back to the network."},
            mcq:{question_id:"L5Q2",question_text:"Why use multiple access points (as per dialogue)?",
              choices:["Improve Wi-Fi coverage","Replace ISP","Eliminate router","Remove passwords"], correct_answer:"Improve Wi-Fi coverage",
              feedback:{correct:"Correct.",wrong:"Try again. Coverage is the key word."}}
          },
          { step_id:"L5_S3", scene_id:"SC_DEVICE_SEGMENTATION",
            dialogue:{speaker:"Guide Bot",text:"Different device types (PC, TV, printer) may be connected in a structured way through the switch."},
            mcq:{question_id:"L5Q3",question_text:"In the scene, which device is connected as a typical wired endpoint?",
              choices:["Printer","Cloud","ISP","Mobile network"], correct_answer:"Printer",
              feedback:{correct:"Correct.",wrong:"Try again. Look at wired endpoints in the dialogue theme."}}
          },
          { step_id:"L5_S4", scene_id:"SC_IOT_CAMERA",
            dialogue:{speaker:"Guide Bot",text:"IoT devices like IP cameras join the network and should be monitored or isolated when needed."},
            mcq:{question_id:"L5Q4",question_text:"Which IoT device is highlighted (as per dialogue)?",
              choices:["IP Camera","Keyboard","Monitor","Mouse"], correct_answer:"IP Camera",
              feedback:{correct:"Correct.",wrong:"Try again. The dialogue names it."}}
          },
          { step_id:"L5_S5", scene_id:"SC_NETWORK_OVERVIEW_ADV",
            dialogue:{speaker:"Guide Bot",text:"An advanced network often uses router + core switch + access points to connect many devices efficiently."},
            mcq:{question_id:"L5Q5",question_text:"Which set matches the dialogue for an advanced setup?",
              choices:["Router + Switch + Access Points","Only a phone","Only ISP tower","Only a printer"],
              correct_answer:"Router + Switch + Access Points",
              feedback:{correct:"Correct.",wrong:"Try again. The dialogue lists the components."}}
          },
        ]}
      ]
    };

    // ---------------------------
    // Scene presets (real mapping)
    // ---------------------------
    const SCENE_PRESETS = {
      // L1
      SC_CITY_TO_HOME: {
        nodes: [
          { id:"ISP", label:"ISP", x:14, y:52 },
          { id:"BACKBONE", label:"Backbone", x:42, y:52 },
          { id:"HOME", label:"Home", x:72, y:52 }
        ],
        links: [["ISP","BACKBONE"],["BACKBONE","HOME"]],
        focus:["ISP"],
        pulsePath:["ISP","BACKBONE","HOME"]
      },
      SC_HOME_FRONT: {
        nodes: [
          { id:"LINE", label:"Line", x:18, y:55 },
          { id:"ONT", label:"ONT/Modem", x:45, y:55 },
          { id:"ROUTER", label:"Router", x:72, y:55 }
        ],
        links: [["LINE","ONT"],["ONT","ROUTER"]],
        focus:["ONT"],
        pulsePath:["LINE","ONT","ROUTER"]
      },
      SC_HOME_NETWORK_OVERVIEW: {
        nodes: [
          { id:"ISP", label:"ISP", x:14, y:55 },
          { id:"ONT", label:"ONT/Modem", x:37, y:55 },
          { id:"ROUTER", label:"Router", x:60, y:55 },
          { id:"DEV", label:"Devices", x:84, y:55 }
        ],
        links: [["ISP","ONT"],["ONT","ROUTER"],["ROUTER","DEV"]],
        focus:["ROUTER"],
        pulsePath:["ISP","ONT","ROUTER","DEV"]
      },
      SC_LIVING_ROOM: {
        nodes: [
          { id:"ONT", label:"ONT/Modem", x:25, y:55 },
          { id:"ROUTER", label:"Router", x:50, y:55 },
          { id:"DEV1", label:"Laptop", x:75, y:40 },
          { id:"DEV2", label:"Mobile", x:75, y:70 }
        ],
        links: [["ONT","ROUTER"],["ROUTER","DEV1"],["ROUTER","DEV2"]],
        focus:["ROUTER"],
        pulsePath:["ONT","ROUTER","DEV1"]
      },

      // L2
      SC_HOME_BLUEPRINT: {
        nodes: [
          { id:"ONT", label:"Modem", x:40, y:22 },
          { id:"ROUTER", label:"Router", x:50, y:52 },
          { id:"DEV1", label:"PC", x:18, y:25 },
          { id:"DEV2", label:"Laptop", x:68, y:78 },
          { id:"DEV3", label:"Mobile", x:84, y:78 }
        ],
        links: [["ONT","ROUTER"],["ROUTER","DEV1"],["ROUTER","DEV2"],["ROUTER","DEV3"]],
        focus:["DEV1"],
        pulsePath:["ONT","ROUTER","DEV2"]
      },
      SC_ROUTER_SETTINGS: {
        nodes: [
          { id:"ROUTER", label:"Router (DHCP)", x:50, y:52 },
          { id:"DEV1", label:"PC", x:18, y:25 },
          { id:"DEV2", label:"Laptop", x:68, y:78 },
          { id:"DEV3", label:"Mobile", x:84, y:78 }
        ],
        links: [["ROUTER","DEV1"],["ROUTER","DEV2"],["ROUTER","DEV3"]],
        focus:["ROUTER"],
        pulsePath:["ROUTER","DEV1","ROUTER","DEV3"]
      },
      SC_HOME_OFFICE: {
        nodes: [
          { id:"ROUTER", label:"Router", x:55, y:52 },
          { id:"SWITCH", label:"Switch", x:40, y:65 },
          { id:"DEV1", label:"Wired PC", x:20, y:35 },
          { id:"DEV2", label:"Printer", x:22, y:80 }
        ],
        links: [["ROUTER","SWITCH"],["SWITCH","DEV1"],["SWITCH","DEV2"]],
        focus:["SWITCH"],
        pulsePath:["ROUTER","SWITCH","DEV2"]
      },

      // L3
      SC_WIFI_OVERVIEW: {
        nodes: [
          { id:"ISP", label:"Internet (ISP)", x:16, y:72 },
          { id:"ROUTER", label:"Wi-Fi Router", x:45, y:72 },
          { id:"DEV", label:"Home Devices", x:78, y:72 }
        ],
        links: [["ISP","ROUTER"],["ROUTER","DEV"]],
        focus:["ROUTER"],
        pulsePath:["ISP","ROUTER","DEV"]
      },
      SC_WIFI_SPEED: {
        nodes: [
          { id:"ISP", label:"ISP Speed", x:20, y:72 },
          { id:"ROUTER", label:"Router", x:50, y:72 },
          { id:"DEV", label:"Device", x:80, y:72 }
        ],
        links: [["ISP","ROUTER"],["ROUTER","DEV"]],
        focus:["ISP","ROUTER"],
        pulsePath:["ISP","ROUTER","DEV"]
      },
      SC_WIFI_COVERAGE: {
        nodes: [
          { id:"ROUTER", label:"Router", x:50, y:55 },
          { id:"DEV1", label:"Near room", x:70, y:35 },
          { id:"DEV2", label:"Far room", x:70, y:80 }
        ],
        links: [["ROUTER","DEV1"],["ROUTER","DEV2"]],
        focus:["DEV2"],
        pulsePath:["ROUTER","DEV2"]
      },
      SC_WIFI_SECURITY: {
        nodes: [
          { id:"ROUTER", label:"Secured Wi-Fi", x:50, y:72 },
          { id:"OK", label:"Authorized", x:80, y:72 },
          { id:"BLOCK", label:"Blocked", x:80, y:35 }
        ],
        links: [["ROUTER","OK"]],
        focus:["ROUTER"],
        pulsePath:["ROUTER","OK"]
      },
      SC_WIFI_GUEST: {
        nodes: [
          { id:"ROUTER", label:"Router", x:50, y:72 },
          { id:"HOME", label:"Home device", x:78, y:45 },
          { id:"GUEST", label:"Guest device", x:78, y:85 }
        ],
        links: [["ROUTER","HOME"],["ROUTER","GUEST"]],
        focus:["GUEST"],
        pulsePath:["ROUTER","GUEST"]
      },

      // L4
      SC_ISP_CABLE: {
        nodes: [
          { id:"HOME", label:"Home", x:18, y:28 },
          { id:"MODEM", label:"Cable Modem", x:38, y:28 },
          { id:"CMTS", label:"CMTS", x:62, y:28 },
          { id:"NET", label:"ISP Internet", x:84, y:28 }
        ],
        links: [["HOME","MODEM"],["MODEM","CMTS"],["CMTS","NET"]],
        focus:["MODEM"],
        pulsePath:["HOME","MODEM","CMTS","NET"]
      },
      SC_ISP_DSL: {
        nodes: [
          { id:"HOME", label:"Home", x:18, y:72 },
          { id:"MODEM", label:"DSL Modem", x:38, y:72 },
          { id:"DSLAM", label:"DSLAM", x:62, y:72 },
          { id:"NET", label:"ISP Internet", x:84, y:72 }
        ],
        links: [["HOME","MODEM"],["MODEM","DSLAM"],["DSLAM","NET"]],
        focus:["DSLAM"],
        pulsePath:["HOME","MODEM","DSLAM","NET"]
      },
      SC_CMTS: {
        nodes: [
          { id:"MODEMS", label:"Cable Modems", x:32, y:28 },
          { id:"CMTS", label:"CMTS", x:58, y:28 },
          { id:"NET", label:"ISP Internet", x:84, y:28 }
        ],
        links: [["MODEMS","CMTS"],["CMTS","NET"]],
        focus:["CMTS"],
        pulsePath:["MODEMS","CMTS","NET"]
      },
      SC_DSLAM: {
        nodes: [
          { id:"MODEMS", label:"DSL Modems", x:32, y:72 },
          { id:"DSLAM", label:"DSLAM", x:58, y:72 },
          { id:"NET", label:"ISP Internet", x:84, y:72 }
        ],
        links: [["MODEMS","DSLAM"],["DSLAM","NET"]],
        focus:["DSLAM"],
        pulsePath:["MODEMS","DSLAM","NET"]
      },
      SC_ISP_ACCESS_OVERVIEW: {
        nodes: [
          { id:"CABLE", label:"Cable Home", x:18, y:32 },
          { id:"CMTS", label:"CMTS", x:48, y:32 },
          { id:"DSL", label:"DSL Home", x:18, y:72 },
          { id:"DSLAM", label:"DSLAM", x:48, y:72 },
          { id:"NET", label:"ISP Internet", x:84, y:52 }
        ],
        links: [["CABLE","CMTS"],["CMTS","NET"],["DSL","DSLAM"],["DSLAM","NET"]],
        focus:["CMTS","DSLAM"],
        pulsePath:["CABLE","CMTS","NET"]
      },

      // L5
      SC_ADVANCED_NETWORK: {
        nodes: [
          { id:"ONT", label:"ISP Modem", x:18, y:18 },
          { id:"ROUTER", label:"Router", x:18, y:38 },
          { id:"SWITCH", label:"Switch", x:38, y:55 },
          { id:"AP1", label:"AP", x:58, y:38 },
          { id:"DEV", label:"Devices", x:80, y:38 }
        ],
        links: [["ONT","ROUTER"],["ROUTER","SWITCH"],["SWITCH","AP1"],["AP1","DEV"]],
        focus:["SWITCH"],
        pulsePath:["ROUTER","SWITCH","AP1","DEV"]
      },
      SC_MULTIPLE_APS: {
        nodes: [
          { id:"ROUTER", label:"Router", x:18, y:38 },
          { id:"SWITCH", label:"Switch", x:38, y:55 },
          { id:"AP1", label:"AP 1", x:58, y:30 },
          { id:"AP2", label:"AP 2", x:58, y:75 },
          { id:"DEV1", label:"Laptop", x:80, y:30 },
          { id:"DEV2", label:"Mobile", x:80, y:75 }
        ],
        links: [["ROUTER","SWITCH"],["SWITCH","AP1"],["SWITCH","AP2"],["AP1","DEV1"],["AP2","DEV2"]],
        focus:["AP1","AP2"],
        pulsePath:["ROUTER","SWITCH","AP1","DEV1"]
      },
      SC_DEVICE_SEGMENTATION: {
        nodes: [
          { id:"SWITCH", label:"Switch", x:38, y:55 },
          { id:"PC", label:"Computer", x:62, y:30 },
          { id:"TV", label:"Smart TV", x:62, y:55 },
          { id:"PRN", label:"Printer", x:62, y:78 }
        ],
        links: [["SWITCH","PC"],["SWITCH","TV"],["SWITCH","PRN"]],
        focus:["PRN"],
        pulsePath:["SWITCH","PRN"]
      },
      SC_IOT_CAMERA: {
        nodes: [
          { id:"ROUTER", label:"Router", x:18, y:38 },
          { id:"SWITCH", label:"Switch", x:38, y:55 },
          { id:"CAM", label:"IP Camera", x:58, y:75 }
        ],
        links: [["ROUTER","SWITCH"],["SWITCH","CAM"]],
        focus:["CAM"],
        pulsePath:["ROUTER","SWITCH","CAM"]
      },
      SC_NETWORK_OVERVIEW_ADV: {
        nodes: [
          { id:"ONT", label:"ISP Modem", x:14, y:18 },
          { id:"ROUTER", label:"Router", x:14, y:38 },
          { id:"SW", label:"Core Switch", x:34, y:55 },
          { id:"AP1", label:"AP 1", x:58, y:30 },
          { id:"AP2", label:"AP 2", x:58, y:78 },
          { id:"DEV", label:"Devices", x:84, y:55 }
        ],
        links: [["ONT","ROUTER"],["ROUTER","SW"],["SW","AP1"],["SW","AP2"],["AP1","DEV"],["AP2","DEV"]],
        focus:["ROUTER"],
        pulsePath:["ONT","ROUTER","SW","AP1","DEV"]
      }
    };

    // ---------------------------
    // State
    // ---------------------------
    function baseState(){
      const ids = CONTENT.levels.map(l => l.level_id);
      const unlocked = {};
      ids.forEach((id, i)=> unlocked[id] = (i===0));
      const completedSteps = {};
      const completedLevels = {};
      const hintsUsed = {};
      ids.forEach(id=>{
        completedSteps[id] = [];
        completedLevels[id] = false;
        hintsUsed[id] = 0;
      });
      return {
        unlockedLevels: unlocked,
        completedSteps,
        completedLevels,
        hintsUsed,
        last: { level_id: ids[0], step_index: 0 }
      };
    }

    let state = loadState();

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return baseState();
        const saved = JSON.parse(raw);
        const merged = { ...baseState(), ...saved };
        for(const lv of CONTENT.levels){
          const id = lv.level_id;
          merged.unlockedLevels[id] = merged.unlockedLevels[id] ?? (id===CONTENT.levels[0].level_id);
          merged.completedSteps[id] = merged.completedSteps[id] || [];
          merged.completedLevels[id] = merged.completedLevels[id] || false;
          merged.hintsUsed[id] = merged.hintsUsed[id] ?? 0;
        }
        return merged;
      }catch{
        return baseState();
      }
    }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function resetProgress(){
      Research.log({ event:"reset_all" });
      localStorage.removeItem(STORAGE_KEY);
      state = baseState();
      saveState();
      renderLanding();
    }

    // ---------------------------
    // Shell
    // ---------------------------
    function overallProgressText(){
      const total = CONTENT.levels.reduce((a,l)=>a + l.steps.length, 0);
      const done = Object.values(state.completedSteps || {}).reduce((a,arr)=>a + (arr?.length||0), 0);
      return `${done}/${total}`;
    }

    function shell(){
      return `
        <div class="container">
          <div class="topbar">
            <div class="brand">
              <div class="logo">NP</div>
              <div>
                <h1>Net Path Adventure</h1>
                <small>Dialogue → MCQ → Correct to progress</small>
              </div>
            </div>

            <div class="chips">
              <span class="chip"><button id="navHome">Home</button></span>
              <span class="chip"><button id="navMap">Level Map</button></span>
              <span class="chip"><button id="navReset">Reset</button></span>
              <span class="chip"><button id="navExport">Export CSV</button></span>
              <span class="chip"><button id="navClearLog">Clear Log</button></span>
              <span class="chip"><b>${MODE === "control" ? "Control" : "GBL"}</b></span>
              <span class="chip">Progress: <b>${overallProgressText()}</b></span>
              <span class="chip">Session: <b>${escapeHtml(SESSION_ID)}</b></span>
            </div>
          </div>

          <div id="page"></div>
        </div>
      `;
    }

    function setPage(html){
      APP.innerHTML = shell();
      document.getElementById("page").innerHTML = html;

      document.getElementById("navHome").onclick = () => renderLanding();
      document.getElementById("navMap").onclick = () => renderMap();
      document.getElementById("navReset").onclick = () =>
        confirmModal("Reset progress?", "This clears learning progress on this device (log remains unless cleared).",
          () => { closeModal(); resetProgress(); });

      document.getElementById("navExport").onclick = () => Research.downloadCSV(`net_path_log_${SESSION_ID}.csv`);
      document.getElementById("navClearLog").onclick = () =>
        confirmModal("Clear research log?", "This deletes the local research log on this device.",
          () => { closeModal(); Research.clear(); showToast("Log cleared ✔"); });
    }

    // ---------------------------
    // Pages
    // ---------------------------
    function renderLanding(){
      logNav("home_view");

      setPage(`
        <div class="card pad">
          <div class="row">
            <div>
              <div style="font-weight:900;font-size:18px;">Start</div>
              <div class="muted">
                Read the dialogue and answer the MCQ based only on that dialogue.
                You must answer correctly to proceed.
              </div>
            </div>
          </div>

          <div class="muted" style="margin-top:10px;">
            Open directly:
            <a class="link" href="?mode=control">Control</a> &nbsp;|&nbsp;
            <a class="link" href="?mode=gbl">GBL</a>
          </div>

          <div class="btn-row">
            <button class="primary" id="btnStart">Start / Resume</button>
            <button class="ghost" id="btnMap2">Open Level Map</button>
            <button class="ghost" id="btnOpenControl">Open Control</button>
            <button class="ghost" id="btnOpenGbl">Open GBL</button>
          </div>

          <div class="muted" style="margin-top:10px;">
            If something fails, an on-screen error will appear at the bottom.
          </div>
        </div>
      `);

      document.getElementById("btnStart").onclick = () => resumeOrStart();
      document.getElementById("btnMap2").onclick = () => renderMap();
      document.getElementById("btnOpenControl").onclick = () => location.href = "?mode=control";
      document.getElementById("btnOpenGbl").onclick = () => location.href = "?mode=gbl";
    }

    function renderMap(){
      logNav("map_view");

      const cards = CONTENT.levels.map((lv, idx) => {
        const unlocked = !!state.unlockedLevels[lv.level_id];
        const done = !!state.completedLevels[lv.level_id];
        const stepsDone = (state.completedSteps[lv.level_id] || []).length;
        const total = lv.steps.length;

        return `
          <div class="level-card ${unlocked ? "" : "locked"}" data-level="${escapeAttr(lv.level_id)}">
            <div class="badge">${idx+1}</div>
            <div style="flex:1;">
              <h3>${escapeHtml(lv.level_title)}</h3>
              <div class="meta">
                <span class="pill">${done ? "Completed ✔" : (unlocked ? "Unlocked" : "Locked")}</span>
                <span class="pill">Progress: ${stepsDone}/${total}</span>
              </div>
              <div class="tags">
                ${lv.learning_focus.slice(0,5).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("")}
              </div>
            </div>
          </div>
        `;
      }).join("");

      setPage(`
        <div class="card pad">
          <div class="row">
            <div>
              <div style="font-weight:900;font-size:18px;">Level Map</div>
              <div class="muted">Choose an unlocked level.</div>
            </div>
          </div>
          <div class="level-list">${cards}</div>
        </div>
      `);

      document.querySelectorAll(".level-card").forEach(el => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-level");
          if(!state.unlockedLevels[id]) return;
          renderLevelIntro(id);
        });
      });
    }

    function renderLevelIntro(levelId){
      const level = getLevel(levelId);
      const stepsDone = (state.completedSteps[levelId] || []).length;
      const total = level.steps.length;

      Research.log({ event:"level_intro_view", level_id: levelId });

      setPage(`
        <div class="card pad">
          <div style="font-weight:900;font-size:18px;">${escapeHtml(level.level_title)}</div>
          <div class="muted">Progress: ${stepsDone}/${total}</div>

          <div class="tags" style="margin-top:10px;">
            ${level.learning_focus.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("")}
          </div>

          <div class="btn-row">
            <button class="primary" id="btnGo">Begin / Continue</button>
            <button class="ghost" id="btnReplay">Replay Level</button>
          </div>
        </div>
      `);

      document.getElementById("btnGo").onclick = () => {
        const nextIndex = getNextStepIndex(levelId);
        state.last = { level_id: levelId, step_index: nextIndex };
        saveState();
        Research.log({ event:"level_start", level_id: levelId, step_index: nextIndex });
        renderPlay(levelId, nextIndex);
      };

      document.getElementById("btnReplay").onclick = () => {
        confirmModal("Replay this level?", "This resets only this level progress.", () => {
          closeModal();
          state.completedSteps[levelId] = [];
          state.completedLevels[levelId] = false;
          state.hintsUsed[levelId] = 0;
          state.last = { level_id: levelId, step_index: 0 };
          saveState();
          Research.log({ event:"level_replay", level_id: levelId });
          renderPlay(levelId, 0);
        });
      };
    }

    function renderPlay(levelId, stepIndex){
      const level = getLevel(levelId);
      const step = level.steps[stepIndex];
      const total = level.steps.length;

      // Step timing baseline for logging
      StepTimer.start(levelId, step.step_id, stepIndex, step.mcq?.question_id || "");

      Research.log({
        event:"step_view",
        level_id: levelId,
        step_id: step.step_id,
        step_index: stepIndex,
        scene_id: step.scene_id,
        question_id: step.mcq?.question_id || ""
      });

      const pct = Math.round(((stepIndex) / total) * 100);
      const gblClass = (MODE !== "control") ? "gbl" : "control";

      setPage(`
        <div class="card pad">
          <div class="play-header">
            <div>
              <div class="play-title">${escapeHtml(level.level_title)}</div>
              <div class="muted">Step ${stepIndex+1} of ${total}</div>
            </div>

            <div class="progress-wrap">
              <div class="progress"><div style="width:${pct}%;"></div></div>
              <div class="muted">Hints used: ${(state.hintsUsed[levelId]||0)} / ${UI.max_hints_per_level}</div>
            </div>

            <div class="btn-row" style="margin:0;">
              <button class="ghost" id="btnExit">Exit</button>
            </div>
          </div>

          <div class="grid two">
            <div class="scene ${gblClass}" id="scene">
              <div class="bgimg ${MODE !== "control" ? "animate" : ""}" id="bgimg"></div>
              <div class="mode-label">${MODE === "control" ? "Control mode (no background, no animation)" : "GBL mode (background + animation)"}</div>
              <svg id="sceneSvg" viewBox="0 0 1000 520" preserveAspectRatio="none" aria-hidden="true"></svg>
              <div class="hint-strip">${escapeHtml(sceneHint(step.scene_id))}</div>
            </div>

            <div>
              <div class="dialogue">
                <div class="avatar">GB</div>
                <div class="bubble">
                  <div class="speaker">${escapeHtml(step.dialogue.speaker || "Guide")}</div>
                  <div class="text">${escapeHtml(step.dialogue.text || "")}</div>
                </div>
              </div>

              <div class="btn-row">
                <button class="primary" id="btnQ">Continue → Question</button>
                <button class="ghost" id="btnMap2">Level Map</button>
              </div>

              <div class="muted" style="margin-top:10px;">
                MCQs are based only on the dialogue shown on this screen.
              </div>
            </div>
          </div>
        </div>
      `);

      document.getElementById("btnExit").onclick = () => {
        Research.log({ event:"level_exit", level_id: levelId, reason:"exit_button" });
        renderLanding();
      };
      document.getElementById("btnMap2").onclick = () => renderMap();
      document.getElementById("btnQ").onclick = () => openMcqModal(levelId, stepIndex);

      setSceneBackground(levelId);
      drawScene(step.scene_id);
    }

    function renderLevelComplete(levelId){
      const level = getLevel(levelId);
      const next = getNextLevelId(levelId);

      Research.log({ event:"level_complete", level_id: levelId });

      setPage(`
        <div class="card pad">
          <div style="font-weight:900;font-size:18px;">Level Complete ✔</div>
          <div class="muted">${escapeHtml(level.level_title)}</div>

          <div class="btn-row">
            <button class="primary" id="btnNext" ${next ? "" : "disabled"}>${next ? "Next Level" : "All done"}</button>
            <button class="ghost" id="btnMap2">Back to Map</button>
          </div>
        </div>
      `);

      document.getElementById("btnMap2").onclick = () => renderMap();
      const btnNext = document.getElementById("btnNext");
      if(btnNext && next){
        btnNext.onclick = () => renderLevelIntro(next);
      }else{
        // game complete
        Research.log({ event:"game_complete" });
      }
    }

    // ---------------------------
    // Background image (GBL only)
    // ---------------------------
    function setSceneBackground(levelId){
      const el = document.getElementById("bgimg");
      if(!el) return;

      if(MODE === "control"){
        el.style.backgroundImage = "none";
        return;
      }

      const url = ASSETS[levelId];
      const img = new Image();
      img.onload = () => { el.style.backgroundImage = `url('${url}')`; };
      img.onerror = () => { el.style.backgroundImage = "none"; };
      img.src = url;
    }

    // ---------------------------
    // Scene renderer (nodes + links + pulse)
    // ---------------------------
    let currentAnimHandle = null;

    function drawScene(sceneId){
      // stop prior animation loop
      if(currentAnimHandle){
        cancelAnimationFrame(currentAnimHandle);
        currentAnimHandle = null;
      }

      const svg = document.getElementById("sceneSvg");
      if(!svg) return;
      svg.innerHTML = "";

      const preset = SCENE_PRESETS[sceneId];
      if(!preset){
        // fallback simple
        svg.appendChild(svgText("No scene preset", 500, 260, 22, true));
        return;
      }

      // build node map
      const nodeMap = new Map();
      for(const n of preset.nodes){
        const px = n.x * 10;      // 0-100 -> 0-1000
        const py = n.y * 5.2;     // 0-100 -> 0-520
        nodeMap.set(n.id, { ...n, px, py });
      }

      // background grid (light)
      svg.appendChild(gridLines());

      // links
      for(const [a,b] of preset.links){
        const A = nodeMap.get(a), B = nodeMap.get(b);
        if(!A || !B) continue;
        svg.appendChild(svgLine(A.px, A.py, B.px, B.py, "rgba(37,99,235,.40)", 10));
        svg.appendChild(svgLine(A.px, A.py, B.px, B.py, "rgba(255,255,255,.65)", 4));
      }

      // nodes
      for(const n of preset.nodes){
        const N = nodeMap.get(n.id);
        const isFocus = (preset.focus || []).includes(n.id);
        svg.appendChild(nodeCard(N.label, N.px, N.py, isFocus));
      }

      // pulse animation only in GBL mode
      if(MODE === "control") return;

      // build pulse path points
      const pathIds = preset.pulsePath || [];
      const pts = pathIds.map(id => nodeMap.get(id)).filter(Boolean).map(p => ({x:p.px, y:p.py}));
      if(pts.length < 2) return;

      currentAnimHandle = animatePulse(pts, svg);
    }

    function animatePulse(points, svg){
      const dot = svgEl("circle", { r:"10", fill:"rgba(37,99,235,.95)" });
      svg.appendChild(dot);

      // create segments with lengths
      const segs = [];
      let total = 0;
      for(let i=0;i<points.length-1;i++){
        const a = points[i], b = points[i+1];
        const d = Math.hypot(b.x-a.x, b.y-a.y);
        segs.push({a,b,d,start:total});
        total += d;
      }

      let t = 0;
      const speed = 2.2; // pixels per frame-ish

      function lerp(a,b,u){ return a + (b-a)*u; }

      function tick(){
        t += speed;
        if(t > total) t = 0;

        let s = segs[0];
        for(const ss of segs){
          if(t >= ss.start && t <= ss.start + ss.d){ s = ss; break; }
        }
        const u = s.d ? (t - s.start)/s.d : 0;
        dot.setAttribute("cx", lerp(s.a.x, s.b.x, u));
        dot.setAttribute("cy", lerp(s.a.y, s.b.y, u));

        currentAnimHandle = requestAnimationFrame(tick);
      }
      currentAnimHandle = requestAnimationFrame(tick);
      return currentAnimHandle;
    }

    function gridLines(){
      const g = svgEl("g", { opacity: "0.22" });
      for(let x=80;x<=920;x+=140){
        g.appendChild(svgEl("line", { x1:x, y1:60, x2:x, y2:460, stroke:"rgba(15,23,42,.08)", "stroke-width":"2" }));
      }
      for(let y=100;y<=420;y+=120){
        g.appendChild(svgEl("line", { x1:80, y1:y, x2:920, y2:y, stroke:"rgba(15,23,42,.08)", "stroke-width":"2" }));
      }
      return g;
    }
    function svgLine(x1,y1,x2,y2, stroke, w){
      return svgEl("line", { x1, y1, x2, y2, stroke, "stroke-width": String(w), "stroke-linecap":"round" });
    }

    function nodeCard(label, x, y, focus){
      const g = svgEl("g", { transform:`translate(${x},${y})` });

      const glow = svgEl("circle", {
        cx:0, cy:0, r: focus ? "44" : "0",
        fill:"rgba(37,99,235,.18)"
      });

      const ring = svgEl("circle", {
        cx:0, cy:0, r:"36",
        fill:"rgba(255,255,255,.92)",
        stroke: focus ? "rgba(37,99,235,.70)" : "rgba(15,23,42,.16)",
        "stroke-width": focus ? "4" : "2"
      });

      const t = svgEl("text", {
        x:0, y:6,
        "text-anchor":"middle",
        "font-size":"18",
        "font-weight":"900",
        fill: focus ? "rgba(11,18,32,1)" : "rgba(84,96,116,1)"
      });
      t.textContent = label;

      g.appendChild(glow);
      g.appendChild(ring);
      g.appendChild(t);
      return g;
    }

    function svgText(text, x, y, size, bold){
      const t = svgEl("text", {
        x, y,
        "text-anchor":"middle",
        "font-size": String(size || 18),
        "font-weight": bold ? "900" : "700",
        fill: "rgba(84,96,116,1)"
      });
      t.textContent = text;
      return t;
    }

    function svgEl(tag, attrs){
      const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
      for(const [k,v] of Object.entries(attrs || {})) el.setAttribute(k, v);
      return el;
    }

    function sceneHint(sceneId){
      const hints = {
        SC_CITY_TO_HOME: "Watch service move from ISP toward the home.",
        SC_HOME_FRONT: "Signal arrives and is converted before routing.",
        SC_HOME_NETWORK_OVERVIEW: "See the full chain: ISP → modem → router → devices.",
        SC_LIVING_ROOM: "Router is the sharing point for devices.",
        SC_HOME_BLUEPRINT: "Router connects multiple devices; addresses matter.",
        SC_ROUTER_SETTINGS: "Router plays a central role in auto assignment.",
        SC_HOME_OFFICE: "Switch adds more wired ports.",
        SC_WIFI_OVERVIEW: "Internet and Wi-Fi are different layers.",
        SC_WIFI_SPEED: "Both ISP and Wi-Fi can be bottlenecks.",
        SC_WIFI_COVERAGE: "Far rooms may get weaker signals.",
        SC_WIFI_SECURITY: "Security controls access and protects data.",
        SC_WIFI_GUEST: "Guest access stays separate from main devices.",
        SC_ISP_CABLE: "Cable modem connects to CMTS at provider side.",
        SC_ISP_DSL: "DSL modem connects to DSLAM at provider side.",
        SC_CMTS: "CMTS aggregates many cable subscribers.",
        SC_DSLAM: "DSLAM terminates multiple DSL lines.",
        SC_ISP_ACCESS_OVERVIEW: "Different last-mile types, same ISP Internet.",
        SC_ADVANCED_NETWORK: "Switch helps scale connections beyond router ports.",
        SC_MULTIPLE_APS: "Two APs improve coverage in different zones.",
        SC_DEVICE_SEGMENTATION: "Multiple wired endpoints sit behind a switch.",
        SC_IOT_CAMERA: "IoT device joins network; monitor or isolate.",
        SC_NETWORK_OVERVIEW_ADV: "Router + switch + APs form an efficient layout."
      };
      return hints[sceneId] || "Observe the animated path and relate it to the dialogue.";
    }

    // ---------------------------
    // MCQ modal (rich logging)
    // ---------------------------
    const AttemptCounter = { byQ: {} };
    const StepTimer = {
      startMs: null,
      current: { level_id:"", step_id:"", step_index:"", question_id:"" },
      start(level_id, step_id, step_index, question_id){
        this.startMs = Date.now();
        this.current = { level_id, step_id, step_index, question_id };
        Research.log({ event:"step_start", level_id, step_id, step_index, question_id });
      },
      timeOnStepSec(){
        if(!this.startMs) return "";
        return Math.round((Date.now() - this.startMs)/1000);
      }
    };

    function openMcqModal(levelId, stepIndex){
      const level = getLevel(levelId);
      const step = level.steps[stepIndex];
      const mcq = step.mcq;

      Research.log({
        event:"mcq_open",
        level_id: levelId, step_id: step.step_id, step_index: stepIndex,
        question_id: mcq.question_id,
        time_on_step_sec: StepTimer.timeOnStepSec()
      });

      let choices = [...mcq.choices];
      if(MODE !== "control" && UI.mcq_shuffle_options){
        choices = UI.deterministic_shuffle
          ? seededShuffle(choices, mcq.question_id || (levelId + "_" + stepIndex))
          : shuffleArray(choices);
      }

      let selected = null;
      let feedback = null;

      const render = () => {
        const maxHints = UI.max_hints_per_level || 0;
        const used = state.hintsUsed[levelId] || 0;
        const left = Math.max(0, maxHints - used);

        MODAL.innerHTML = `
          <div class="modal-backdrop" role="dialog" aria-modal="true">
            <div class="modal">
              <header>
                <h3>Question</h3>
                <button class="ghost" id="btnClose" ${UI.lock_until_correct ? "disabled" : ""}>Close</button>
              </header>
              <div class="body">
                <div class="qtitle">${escapeHtml(mcq.question_text)}</div>

                ${choices.map(c => `
                  <button class="option ${selected===c ? "selected" : ""}" data-choice="${escapeAttr(c)}">${escapeHtml(c)}</button>
                `).join("")}

                ${feedback ? `<div class="feedback ${feedback.type}">${escapeHtml(feedback.text)}</div>` : ""}
              </div>
              <footer>
                ${UI.hint_tokens_enabled ? `<button id="btnHint" class="ghost" ${left<=0 ? "disabled" : ""}>Hint (${left} left)</button>` : ""}
                <button id="btnSubmit" class="primary" ${selected ? "" : "disabled"}>Submit</button>
              </footer>
            </div>
          </div>
        `;

        const btnClose = document.getElementById("btnClose");
        if(btnClose) btnClose.onclick = () => closeModal();

        document.querySelectorAll(".option").forEach(btn => {
          btn.onclick = () => {
            selected = btn.getAttribute("data-choice");
            feedback = null;

            Research.log({
              event:"mcq_option_select",
              level_id: levelId, step_id: step.step_id, step_index: stepIndex,
              question_id: mcq.question_id,
              selected_answer: selected,
              time_on_step_sec: StepTimer.timeOnStepSec()
            });

            render();
          };
        });

        const btnHint = document.getElementById("btnHint");
        if(btnHint){
          btnHint.onclick = () => {
            const maxHints = UI.max_hints_per_level || 0;
            const used = state.hintsUsed[levelId] || 0;
            if(used >= maxHints) return;

            state.hintsUsed[levelId] = used + 1;
            saveState();

            Research.log({
              event:"hint_used",
              level_id: levelId, step_id: step.step_id, step_index: stepIndex,
              question_id: mcq.question_id,
              hints_used_level: state.hintsUsed[levelId],
              time_on_step_sec: StepTimer.timeOnStepSec()
            });

            feedback = { type: "good", text: buildHint(step.dialogue.text, mcq.correct_answer) };
            render();
          };
        }

        document.getElementById("btnSubmit").onclick = () => {
          const key = mcq.question_id || "unknown";
          AttemptCounter.byQ[key] = (AttemptCounter.byQ[key] || 0) + 1;

          const ok = (selected === mcq.correct_answer);
          const timeOnStep = StepTimer.timeOnStepSec();

          Research.log({
            event:"mcq_attempt",
            level_id: levelId, step_id: step.step_id, step_index: stepIndex,
            question_id: mcq.question_id,
            attempt_no: AttemptCounter.byQ[key],
            selected_answer: selected,
            correct_answer: mcq.correct_answer,
            is_correct: ok ? 1 : 0,
            time_on_step_sec: timeOnStep,
            hints_used_level: state.hintsUsed[levelId] || 0
          });

          if(ok){
            feedback = { type:"good", text: mcq.feedback?.correct || "Correct." };
            render();

            // step complete
            Research.log({
              event:"step_complete",
              level_id: levelId, step_id: step.step_id, step_index: stepIndex,
              question_id: mcq.question_id,
              attempts_for_question: AttemptCounter.byQ[key],
              time_on_step_sec: timeOnStep
            });

            setTimeout(() => {
              markStepComplete(levelId, step.step_id);
              closeModal();
              showToast("Correct ✔");
              setTimeout(() => advance(levelId, stepIndex), 260);
            }, 220);
          }else{
            feedback = { type:"bad", text: mcq.feedback?.wrong || "Try again." };
            render();
          }
        };
      };

      render();
    }

    function closeModal(){ MODAL.innerHTML = ""; }

    function confirmModal(title, msg, onYes){
      MODAL.innerHTML = `
        <div class="modal-backdrop" role="dialog" aria-modal="true">
          <div class="modal">
            <header>
              <h3>${escapeHtml(title)}</h3>
              <button class="ghost" id="mClose">Close</button>
            </header>
            <div class="body"><div class="muted">${escapeHtml(msg)}</div></div>
            <footer>
              <button class="ghost" id="mNo">Cancel</button>
              <button class="primary" id="mYes">Yes</button>
            </footer>
          </div>
        </div>
      `;
      document.getElementById("mClose").onclick = () => closeModal();
      document.getElementById("mNo").onclick = () => closeModal();
      document.getElementById("mYes").onclick = () => onYes && onYes();
    }

    // ---------------------------
    // Toast
    // ---------------------------
    function showToast(text){
      if(text) TOAST.textContent = text;
      TOAST.classList.add("show");
      setTimeout(() => TOAST.classList.remove("show"), 900);
    }

    // ---------------------------
    // Progress logic
    // ---------------------------
    function resumeOrStart(){
      const last = state.last || { level_id: CONTENT.levels[0].level_id, step_index: 0 };
      const levelId = last.level_id;
      const nextIdx = getNextStepIndex(levelId);

      state.last = { level_id: levelId, step_index: nextIdx };
      saveState();

      Research.log({ event:"resume_start", level_id: levelId, step_index: nextIdx });

      renderPlay(levelId, nextIdx);
    }

    function getLevel(levelId){
      const lv = CONTENT.levels.find(l => l.level_id === levelId);
      if(!lv) throw new Error("Level not found: " + levelId);
      return lv;
    }

    function getNextStepIndex(levelId){
      const level = getLevel(levelId);
      const done = new Set(state.completedSteps[levelId] || []);
      for(let i=0;i<level.steps.length;i++){
        if(!done.has(level.steps[i].step_id)) return i;
      }
      return Math.max(0, level.steps.length - 1);
    }

    function markStepComplete(levelId, stepId){
      const arr = state.completedSteps[levelId] || [];
      if(!arr.includes(stepId)){
        arr.push(stepId);
        state.completedSteps[levelId] = arr;
        saveState();
      }
    }

    function advance(levelId, stepIndex){
      const level = getLevel(levelId);
      const doneCount = (state.completedSteps[levelId] || []).length;

      if(doneCount >= level.steps.length){
        state.completedLevels[levelId] = true;

        const next = getNextLevelId(levelId);
        if(next) state.unlockedLevels[next] = true;

        state.last = { level_id: levelId, step_index: level.steps.length - 1 };
        saveState();

        Research.log({ event:"level_completed", level_id: levelId, unlocked_next: next || "" });

        renderLevelComplete(levelId);
        return;
      }

      const nextIdx = getNextStepIndex(levelId);
      state.last = { level_id: levelId, step_index: nextIdx };
      saveState();

      renderPlay(levelId, nextIdx);
    }

    function getNextLevelId(levelId){
      const idx = CONTENT.levels.findIndex(l => l.level_id === levelId);
      return CONTENT.levels[idx + 1] ? CONTENT.levels[idx + 1].level_id : null;
    }

    // ---------------------------
    // Hints
    // ---------------------------
    function buildHint(dialogueText, correctAnswer){
      const t = (dialogueText || "").toLowerCase();
      const a = (correctAnswer || "").toLowerCase();
      if(a && t.includes(a)) return `Hint: Look for “${correctAnswer}” in the dialogue.`;
      return "Hint: Re-read the dialogue and match the key term.";
    }

    // ---------------------------
    // Shuffle helpers
    // ---------------------------
    function seededShuffle(arr, seedStr){
      const a = [...arr];
      let seed = xfnv1a(seedStr);
      for(let i=a.length-1;i>0;i--){
        seed = mulberry32(seed)();
        const j = Math.floor(seed * (i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    function xfnv1a(str){
      let h = 2166136261 >>> 0;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }
    function mulberry32(a){
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    function shuffleArray(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // ---------------------------
    // Escape helpers
    // ---------------------------
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(s){ return escapeHtml(s); }

    // ---------------------------
    // Start
    // ---------------------------
    renderLanding();
  </script>
</body>
</html>
